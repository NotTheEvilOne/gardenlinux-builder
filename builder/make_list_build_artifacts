#!/usr/bin/env bash

set -euo pipefail
shopt -s nullglob

cname="$1"

IFS=',' read -r -a features < <(./parse_features --feature-dir features --cname "$cname" features)

artifacts=(".build/$cname-$COMMIT.tar" ".build/$cname-$COMMIT.release" ".build/$cname-$COMMIT.manifest")

for feature in "${features[@]}"; do
	for i in "features/$feature/"{image,convert}.*; do
		extension="$(grep -E -o '(\.[a-z][a-zA-Z0-9\-_~]*)*$' <<< "$i")"
		artifacts+=(".build/$cname-$COMMIT${extension%~*}")
	done
done

if [ "${#artifacts[@]}" = 3 ] && [ -n "$(./parse_features --feature-dir "features" --cname "$cname" platforms)" ]; then
	artifacts+=(".build/$cname-$COMMIT.raw")
fi

# printf 'DEBUG: [%s] %s -> %s\n' "$0" "$*" "${artifacts[*]}" >&2
echo "${artifacts[@]}"
